name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          extensions: mbstring, xml, curl
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist
      
      - name: Run PHPCS
        run: vendor/bin/phpcs --standard=phpcs.xml src/
      
      - name: Run PHPStan
        run: vendor/bin/phpstan analyse src/ --level=5

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['7.4', '8.0', '8.1', '8.2']
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, xml, curl
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist
      
      - name: Run unit tests
        run: vendor/bin/phpunit --testsuite=Unit
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: tests/coverage/coverage.xml
          flags: unit

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, curl
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist
      
      - name: Run integration tests
        run: vendor/bin/phpunit --testsuite=Integration

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, curl
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist
      
      - name: Run security tests
        run: vendor/bin/phpunit --testsuite=Security
      
      - name: Run PHPStan security rules
        run: vendor/bin/phpstan analyse src/ --level=max --configuration=phpstan-security.neon || true

  functional-tests:
    name: Functional Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, curl
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist
      
      - name: Run functional tests
        run: vendor/bin/phpunit --testsuite=Functional

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Playwright
        run: npm install -g @playwright/test
      
      - name: Install dependencies
        run: npm install
      
      - name: Run E2E tests
        run: npx playwright test
        env:
          WP_URL: ${{ secrets.WP_URL }}

  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, curl
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist
      
      - name: Generate coverage
        run: vendor/bin/phpunit --coverage-html tests/coverage/html --coverage-text=tests/coverage/coverage.txt
      
      - name: Upload coverage
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: tests/coverage/html










